const schematics = [
    {
        title: "Автосборка корпусов",
        description: "Автосборка андезитов/латунных/медных корпусов",
        detailedDescription: "Схематика механизма автосборки корпусов, для которых требуется 1 вид материала + обтёсанное бревно. Масштаб: 4х2х4 (ДхШхВ)",
        tags: ["автосборка", "корпуса", "1.20.1", "0.5.1"],
        image: "/img/amythest/andesite_brass_copper_casing_maker+.nbt-1.png",
        images: [
            "/img/amythest/andesite_brass_copper_casing_maker+.nbt-1.png",
            "/img/amythest/andesite_brass_copper_casing_maker+.nbt-2.png"
        ],
        downloads: [
            { name: "andesite_brass_copper_casing_maker+.nbt", description: "Схематика v2", url: "/files/amythest/andesite_brass_copper_casing_maker+.nbt" }
        ],
        resources: [
            { text: "Автономный активатор x1", icon: "/img/minecraft/64x/автономный-активатор.png" },
            { text: "Вал x2", icon: "/img/minecraft/64x/вал.png" },
            { text: "Воронка x1", icon: "/img/minecraft/64x/воронка.png" },
            { text: "Коробка передач х6", icon: "/img/minecraft/64x/коробка-передач.png" },
            { text: "Латунный шлюз x1", icon: "/img/minecraft/64x/латунный-шлюз.png" },
            { text: "Механическая пила x1", icon: "/img/minecraft/64x/механическая-пила.png" },
            { text: "Механический ремень x1", icon: "/img/minecraft/64x/механический-ремень.png" },
            { text: "Сундук x5", icon: "/img/minecraft/64x/сундук.png" },
            { text: "Умный жёлоб x1", icon: "/img/minecraft/64x/умный-жёлоб.png" },
            { text: "Фильтр атрибутов x1", icon: "/img/minecraft/64x/фильтр-атрибутов.png" },
            { text: "Фильтр предметов x1", icon: "/img/minecraft/64x/фильтр-предметов.png" }
        ]
    },
    {
        title: "Ферма опыта | Чешуйницы | Batsy",
        description: "Ферма опыта на чешуйницах от Batsy (модифицированная)",
        detailedDescription: "Схематика фермы опыта на чешуйницах от Batsy, была модифицирована для быстрого развёртывания. Масштаб: 12x12x9 (ДхШхВ)",
        tags: ["ферма", "ферма опыта", "чешуйницы", "1.20.1", "0.5.1"],
        image: "/img/amythest/batsy_exp_farm_reverse.nbt-1.png",
        images: [
            "/img/amythest/batsy_exp_farm_reverse.nbt-1.png",
            "/img/amythest/batsy_exp_farm_reverse.nbt-2.png"
        ],
        downloads: [
            { name: "batsy_exp_farm_reverse.nbt", description: "Схематика reverse", url: "/files/amythest/batsy_exp_farm_reverse.nbt" }
        ],
        resources: [
            { text: "Автономный активатор x27", icon: "/img/minecraft/64x/автономный-активатор.png" },
            { text: "Андезитовый корпус х89", icon: "/img/minecraft/64x/андезитовый-корпус.png" },
            { text: "Андезитовый шлюз х12", icon: "/img/minecraft/64x/андезитовый-шлюз.png" },
            { text: "Бочка х1", icon: "/img/minecraft/64x/бочка.png" },
            { text: "Вагонетка х1", icon: "/img/minecraft/64x/вагонетка.png" },
            { text: "Вагонеточный сборщик х1", icon: "/img/minecraft/64x/вагонеточный-сборщик.png" },
            { text: "Вал х23", icon: "/img/minecraft/64x/вал.png" },
            { text: "Вал линейного привода х4", icon: "/img/minecraft/64x/вал-линейного-привода.png" },
            { text: "Вентилятор в корпусе х2", icon: "/img/minecraft/64x/вентилятор-в-корпусе.png" },
            { text: "Дубовый люк х12", icon: "/img/minecraft/64x/дубовый-люк.png" },
            { text: "Еловый люк х8", icon: "/img/minecraft/64x/еловый-люк.png" },
            { text: "Жидкостный бак х9", icon: "/img/minecraft/64x/жидкостный-бак.png" },
            { text: "Жёлоб х27", icon: "/img/minecraft/64x/жёлоб.png" },
            { text: "Каменная нажимная плита х2", icon: "/img/minecraft/64x/каменная-нажимная-плита.png" },
            { text: "Каретка линейного привода х2", icon: "/img/minecraft/64x/каретка-линейного-привода.png" },
            { text: "Коробка передач х5", icon: "/img/minecraft/64x/коробка-передач.png" },
            { text: "Костёр душ х1", icon: "/img/minecraft/64x/костёр-душ.png" },
            { text: "Латунный шлюз х6", icon: "/img/minecraft/64x/латунный-шлюз.png" },
            { text: "Лианы х1", icon: "/img/minecraft/64x/лианы.png" },
            { text: "Линейное шасси х29", icon: "/img/minecraft/64x/линейное-шасси.png" },
            { text: "Механическая помпа х9", icon: "/img/minecraft/64x/механическая-помпа.png" },
            { text: "Механический ремень х8", icon: "/img/minecraft/64x/механический-ремень.png" },
            { text: "Питаемый рычаг х1", icon: "/img/minecraft/64x/питаемый-рычаг.png" },
            { text: "Плита из каменного кирпича х18", icon: "/img/minecraft/64x/плита-из-каменного-кирпича.png" },
            { text: "Реверсивная передача х2", icon: "/img/minecraft/64x/реверсивная-передача.png" },
            { text: "Редстоуновая пыль х4", icon: "/img/minecraft/64x/редстоуновая-пыль.png" },
            { text: "Редстоуновый передатчик сигнала х2", icon: "/img/minecraft/64x/редстоуновый-передатчик-сигнала.png" },
            { text: "Редстоуновый удлинитель импульса х2", icon: "/img/minecraft/64x/редстоуновый-удлинитель-импульса.png" },
            { text: "Рельсы х1", icon: "/img/minecraft/64x/рельсы.png" },
            { text: "Рычаг х5", icon: "/img/minecraft/64x/рычаг.png" },
            { text: "Стекло х63", icon: "/img/minecraft/64x/стекло.png" },
            { text: "Стойка для брони х1", icon: "/img/minecraft/64x/стойка-для-брони.png" },
            { text: "Суперклей х1", icon: "/img/minecraft/64x/суперклей.png" },
            { text: "Сцепление х1", icon: "/img/minecraft/64x/сцепление.png" },
            { text: "Хранилище предметов х89", icon: "/img/minecraft/64x/хранилище-предметов.png" },
            { text: "Цепной привод в корпусе х13", icon: "/img/minecraft/64x/цепной-привод-в-корпусе.png" },
            { text: "Шестерня х2", icon: "/img/minecraft/64x/шестерня.png" }
        ]
    },
    {
        title: "Горелка всплоха с соломкой",
        description: "Да, просто горелка всплоха с соломкой",
        detailedDescription: "Схематика, которая содержит лишь 1 блок - горелка всполоха с соломкой из Create: Crafts & Additions. Масштаб: 1х1х1 (ДхШхВ)",
        tags: ["1.20.1", "0.5.1"],
        image: "/img/amythest/blaze_burner_with_straw.nbt-1.png",
        images: [
            "/img/amythest/blaze_burner_with_straw.nbt-1.png"
        ],
        downloads: [
            { name: "blaze_burner_with_straw.nbt", description: "Схематика", url: "/files/amythest/blaze_burner_with_straw.nbt" }
        ],
        resources: [
            { text: "Горелка всплоха х1", icon: "/img/minecraft/64x/горелка-всполоха.png" }
        ]
    },
    {
        title: "Автосоздание теста",
        description: "Схематика, создающая тесто.",
        detailedDescription: "Схематика механизма, создающего тесто. Требует пшеницу (и воду (если выбрать схематику с водой извне)) извне. Из лишних семян делается костная мука (В соотношении 64 теста к 1 костной муке). Масштаб: 4х3х6 (ДхШхВ)",
        tags: ["автосборка", "тесто", "костная мука", "1.20.1", "0.5.1"],
        image: "/img/amythest/auto_dough_maker.nbt-1.png",
        images: [
            "/img/amythest/auto_dough_maker.nbt-1.png",
            "/img/amythest/auto_dough_maker.nbt-2.png"
        ],
        downloads: [
            { name: "auto_dough_maker.nbt", description: "Схематика (с водой извне)", url: "/files/amythest/auto_dough_maker.nbt" },
            { name: "auto_dough_maker_without_out_water.nbt", description: "Схематика (без воды извне)", url: "/files/amythest/auto_dough_maker_without_out_water.nbt" }
        ],
        resources: [
            { text: "Автономный активатор х1", icon: "/img/minecraft/64x/автономный-активатор.png" },
            { text: "Вал х3", icon: "/img/minecraft/64x/вал.png" },
            { text: "Воронка х3", icon: "/img/minecraft/64x/воронка.png" },
            { text: "Дубовые ступеньки х3 (Схематика без воды извне)", icon: "/img/minecraft/64x/дубовые-ступеньки.png" },
            { text: "Жидкостная труба х2", icon: "/img/minecraft/64x/жидкостная-труба.png" },
            { text: "Жёрнов х1", icon: "/img/minecraft/64x/жёрнов.png" },
            { text: "Компостница х1", icon: "/img/minecraft/64x/компостница.png" },
            { text: "Коробка передач х1", icon: "/img/minecraft/64x/коробка-передач.png" },
            { text: "Латунный шлюз х6", icon: "/img/minecraft/64x/латунный-шлюз.png" },
            { text: "Механическая помпа х1", icon: "/img/minecraft/64x/механическая-помпа.png" },
            { text: "Механический смешиватель х1", icon: "/img/minecraft/64x/механический-смешиватель.png" },
            { text: "Сундук х4", icon: "/img/minecraft/64x/сундук.png" },
            { text: "Чаша х1", icon: "/img/minecraft/64x/чаша.png" },
            { text: "Шестерня х7", icon: "/img/minecraft/64x/шестерня.png" }
        ]
    },
    {
        title: "Двигатель | Alpha",
        description: "Двигатель на 147к ен, требующий лаву извне",
        detailedDescription: "Схематика двигателя, разработанного мной. Для запуска требует 2560ен. Требует лаву извне. Подключение нескольких двигателей происходит через вверх (через башню из коробок передач). Масштаб: 6х4х7 (ДхШхВ)",
        tags: ["двигатель", "1.20.1", "0.5.1"],
        image: "/img/amythest/my_engine_alpha_0_0_2.nbt-1.png",
        images: [
            "/img/amythest/my_engine_alpha_0_0_2.nbt-1.png",
            "/img/amythest/my_engine_alpha_0_0_2.nbt-2.png"
        ],
        downloads: [
            { name: "my_engine_alpha_0_0_2.nbt", description: "Схематика Alpha v.0.0.2", url: "/files/amythest/my_engine_alpha_0_0_2.nbt" }
        ],
        resources: [
            { text: "Большая шестерня х1", icon: "/img/minecraft/64x/большая-шестерня.png" },
            { text: "Вал х9", icon: "/img/minecraft/64x/вал.png" },
            { text: "Горелка всполоха х9", icon: "/img/minecraft/64x/горелка-всполоха.png" },
            { text: "Дубовые ступеньки х5", icon: "/img/minecraft/64x/дубовые-ступеньки.png" },
            { text: "Жидкостная труба х18", icon: "/img/minecraft/64x/жидкостная-труба.png" },
            { text: "Жидкостный бак х36", icon: "/img/minecraft/64x/жидкостный-бак.png" },
            { text: "Катушка со шлангом х1", icon: "/img/minecraft/64x/катушка-со-шлангом.png" },
            { text: "Коробка передач х11", icon: "/img/minecraft/64x/коробка-передач.png" },
            { text: "Механическая помпа х2", icon: "/img/minecraft/64x/механическая-помпа.png" },
            { text: "Паровой двигатель х9", icon: "/img/minecraft/64x/паровой-двигатель.png" },
            { text: "Регулятор скорости вращения х1", icon: "/img/minecraft/64x/регулятор-скорости-вращения.png" },
            { text: "Шестерня х3", icon: "/img/minecraft/64x/шестерня.png" },
        ]
    }
];

let selectedTags = [];

// Получить все уникальные теги
function getAllTags() {
    const tags = new Set();
    schematics.forEach(s => s.tags.forEach(tag => tags.add(tag)));
    return Array.from(tags);
}

// Отобразить теги
function renderTags() {
    const tagList = document.getElementById('tag-list');
    tagList.innerHTML = '';
    const tags = getAllTags();
    tags.forEach(tag => {
        const tagElement = document.createElement('span');
        tagElement.classList.add('tag');
        if (selectedTags.includes(tag)) {
            tagElement.classList.add('active');
        }
        tagElement.textContent = tag;
        tagElement.onclick = () => toggleTag(tag);
        tagList.appendChild(tagElement);
    });
}

// Переключение тега
function toggleTag(tag) {
    if (selectedTags.includes(tag)) {
        selectedTags = selectedTags.filter(t => t !== tag);
    } else {
        selectedTags.push(tag);
    }
    renderTags();
    filterSchematics();
}

// Фильтрация схем
function filterSchematics() {
    const grid = document.getElementById('schematics-grid');
    grid.innerHTML = '';
    const filtered = selectedTags.length === 0
        ? schematics
        : schematics.filter(s => selectedTags.every(tag => s.tags.includes(tag)));

    filtered.forEach(s => {
        const originalIndex = schematics.indexOf(s);
        const card = document.createElement('div');
        card.classList.add('schematic-card');
        card.innerHTML = `
            <img src="${s.image}" alt="${s.title}">
            <div class="content">
                <h3>${s.title}</h3>
                <p>${s.description}</p>
                <div class="tags">${s.tags.join(', ')}</div>
                <a href="schematic.html?id=${originalIndex}" class="open-button">Открыть</a>
            </div>
        `;
        grid.appendChild(card);
    });
}

// Поиск тегов
document.getElementById('tag-search').addEventListener('input', (e) => {
    const search = e.target.value.toLowerCase();
    const tagList = document.getElementById('tag-list');
    tagList.innerHTML = '';
    const tags = getAllTags().filter(tag => tag.toLowerCase().includes(search));
    tags.forEach(tag => {
        const tagElement = document.createElement('span');
        tagElement.classList.add('tag');
        if (selectedTags.includes(tag)) {
            tagElement.classList.add('active');
        }
        tagElement.textContent = tag;
        tagElement.onclick = () => toggleTag(tag);
        tagList.appendChild(tagElement);
    });
});

// Добавление новой схемы
function addSchematic() {
    const title = document.getElementById('new-title').value.trim();
    const description = document.getElementById('new-description').value.trim();
    const detailedDescription = document.getElementById('new-detailed-description').value.trim();
    const tags = document.getElementById('new-tags').value.split(',').map(t => t.trim()).filter(t => t);
    const image = document.getElementById('new-image').value.trim() || '/img/placeholders/purple_place_holder.png';
    const imagesInput = document.getElementById('new-images').value.split(',').map(i => i.trim()).filter(i => i);
    const images = imagesInput.length > 0 ? imagesInput : [image];
    const resourcesInput = document.getElementById('new-resources').value.split('\n').map(r => r.trim()).filter(r => r);
    const resources = resourcesInput.map(r => {
        const [text, icon] = r.split('|').map(s => s.trim());
        return { text: text || 'Ресурс', icon: icon || null };
    });
    const downloadsInput = document.getElementById('new-downloads').value.split('\n').map(d => d.trim()).filter(d => d);
    const downloads = downloadsInput.map(d => {
        const [name, url, description] = d.split('|').map(s => s.trim());
        return { name: name || 'Файл', url: url || '#', description: description || 'Без описания' };
    });

    if (title && description && tags.length > 0) {
        schematics.push({
            title,
            description,
            detailedDescription: detailedDescription || 'Подробное описание отсутствует',
            tags,
            image,
            images,
            downloads: downloads.length > 0 ? downloads : [{ name: "Новая_схема.pdf", description: "Файл с новой схемой", url: "#" }],
            resources: resources.length > 0 ? resources : [{ text: "Материалы не указаны", icon: null }]
        });
        document.getElementById('new-title').value = '';
        document.getElementById('new-description').value = '';
        document.getElementById('new-detailed-description').value = '';
        document.getElementById('new-tags').value = '';
        document.getElementById('new-image').value = '';
        document.getElementById('new-images').value = '';
        document.getElementById('new-resources').value = '';
        document.getElementById('new-downloads').value = '';
        renderTags();
        filterSchematics();
    }
}

// Инициализация
document.addEventListener('DOMContentLoaded', () => {
    renderTags();
    filterSchematics();
});